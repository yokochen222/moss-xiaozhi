# SD卡故障排除指南

## 🔍 问题诊断

### 当前配置
- **引脚配置**: CS=48, SCK=39, MOSI=42, MISO=46
- **供电**: 5V (从ESP32的5V引脚)
- **外置模块**: 购买的SD卡模块

## ⚠️ 可能的问题

### 1. 电压兼容性问题 (最可能)
**问题**: 您的外置SD卡模块需要5V供电，但ESP32的GPIO引脚工作在3.3V。

**症状**: 
- SPI通信失败
- 返回 `ESP_ERR_INVALID_STATE` 错误
- SD卡无法被识别

**解决方案**:
1. **检查模块规格**: 确认您的SD卡模块是否支持3.3V逻辑电平
2. **电平转换**: 如果模块输出5V信号，需要电平转换器
3. **更换模块**: 使用支持3.3V逻辑的SD卡模块

### 2. 上拉电阻缺失
**问题**: SPI通信需要上拉电阻确保信号稳定。

**解决方案**:
- 在CS、SCK、MOSI、MISO引脚上添加10kΩ上拉电阻到3.3V
- 或者使用内置上拉电阻的SD卡模块

### 3. 引脚冲突
**问题**: 当前引脚可能与板级配置冲突。

**解决方案**:
- 编辑 `sdcard_config.h` 文件
- 切换到标准SPI引脚配置：
  ```c
  // 注释掉当前配置
  // #define SDCARD_CONFIG_CUSTOM
  // 启用标准配置
  #define SDCARD_CONFIG_STANDARD
  ```

### 4. 硬件连接问题
**检查清单**:
- [ ] SD卡已正确插入模块
- [ ] 所有连接线牢固，无松动
- [ ] 电源连接正确 (5V供电，3.3V逻辑)
- [ ] 地线连接良好
- [ ] 上拉电阻已添加

## 🛠️ 调试步骤

### 步骤1: 启用详细日志
当前代码已包含详细的调试信息，重新编译并运行以查看具体错误。

### 步骤2: 测试不同配置
1. 尝试标准SPI引脚配置
2. 降低SPI频率到1MHz
3. 检查电压兼容性设置

### 步骤3: 硬件验证
使用万用表检查：
- 电源电压是否正确
- 信号线是否有短路或开路
- 上拉电阻是否正确连接

## 📋 推荐的硬件配置

### 选项1: 使用标准SPI引脚
```
CS  -> GPIO 10
SCK -> GPIO 12  
MOSI -> GPIO 11
MISO -> GPIO 13
VCC -> 5V (模块供电)
GND -> GND
```

### 选项2: 使用3.3V兼容模块
- 购买支持3.3V逻辑电平的SD卡模块
- 使用3.3V供电和逻辑电平
- 添加10kΩ上拉电阻

### 选项3: 添加电平转换器
- 使用74HC125或类似的电平转换芯片
- 将5V信号转换为3.3V信号
- 保护ESP32的GPIO引脚

## 🔧 软件配置

### 切换到标准引脚配置
1. 编辑 `main/common/sdcard/sdcard_config.h`
2. 注释掉 `#define SDCARD_CONFIG_CUSTOM`
3. 启用 `#define SDCARD_CONFIG_STANDARD`
4. 重新编译和烧录

### 降低SPI频率
如果通信不稳定，可以降低SPI频率：
```c
#define SDCARD_SPI_FREQUENCY SDCARD_SPI_FREQUENCY_1MHZ
```

## 📞 获取帮助

如果问题仍然存在，请提供以下信息：
1. 详细的错误日志
2. SD卡模块的型号和规格
3. 硬件连接照片
4. 万用表测量结果

这将帮助进一步诊断问题。
